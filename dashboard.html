<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Calificaciones de Asesores PARABARBEROS</title>
    <!-- Carga de Tailwind CSS para el estilo --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Carga de Chart.js para los gráficos --><script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #d4d4d4;
        }
        .card {
            background-color: #0d0d0d;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        select, input, button {
            transition: all 0.2s;
            border-radius: 0.5rem; /* rounded-lg */
        }
        /* Estilos específicos para los selects e inputs en modo oscuro */
        select, input[type="month"], input[type="text"], input[type="email"], input[type="password"] {
            background-color: #262626 !important;
            color: #d4d4d4 !important;
            border-color: #4a4a4a !important;
            padding: 0.5rem;
        }
        /* Asegura que el contenedor de la tabla tenga scroll vertical si es necesario */
        #ratings-table-container {
            max-height: 400px; /* Altura máxima para evitar que el cuerpo principal crezca sin control */
            overflow-y: auto;
            overflow-x: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col min-h-screen">

    <!-- Pantalla de Login (Visible por defecto) -->
    <div id="login-screen" class="absolute inset-0 bg-gray-900 flex items-center justify-center p-4 z-50">
        <div class="card p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h2 class="text-3xl font-bold text-white mb-6">Dashboard Atención al cliente PARABARBEROS</h2>
            
            <input type="email" id="login-email" placeholder="Correo Electrónico" class="w-full mb-3 border-gray-700">
            <input type="password" id="login-password" placeholder="Contraseña" class="w-full mb-4 border-gray-700">
            
            <button id="login-button" class="w-full bg-black hover:bg-gray-800 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300 mb-2 border border-gray-700">
                Iniciar Sesión
            </button>
            <button id="register-button" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-300">
                Registrarse (Primer Administrador)
            </button>
            
            <p id="login-message" class="text-sm text-red-400 mt-4 hidden"></p>
        </div>
    </div>


    <!-- Contenido Principal del Dashboard (Oculto por defecto) -->
    <div id="main-dashboard-content" class="flex-grow hidden">

        <!-- Encabezado del Dashboard --><header class="mb-8 flex items-center">
            <!-- Contenedor para el Logo -->
            <div class="mr-4">
                <img src="path/to/your/logo.png" alt="Logo Barbero Pro" class="w-16 h-16 object-contain rounded-full">
            </div>
            <div>
                <h1 class="text-4xl font-extrabold text-white mb-2">Panel de Control Barbero Pro</h1>
                <p class="text-gray-400">Análisis de rendimiento de asesores en tiempo real.</p>
            </div>
        </header>

        <!-- Sección de Filtros y Métrica Global --><section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            
            <!-- Filtro de Asesor --><div class="card p-4 rounded-lg shadow-xl">
                <label for="asesor-filter" class="block text-sm font-medium text-gray-400">Filtrar por Asesor</label>
                <select id="asesor-filter" class="mt-1 block w-full border text-white focus:ring-gray-600 focus:border-gray-600">
                    <option value="all">Todos los Asesores</option>
                    <!-- Los nombres de los asesores se llenarán con JavaScript --></select>
            </div>

            <!-- Filtro de Mes --><div class="card p-4 rounded-lg shadow-xl">
                <label for="month-filter" class="block text-sm font-medium text-gray-400">Filtrar por Mes</label>
                <input type="month" id="month-filter" class="mt-1 block w-full border text-white focus:ring-gray-600 focus:border-gray-600">
            </div>

            <!-- Métrica: Calificación Promedio Global --><div class="card p-4 rounded-lg shadow-xl text-center">
                <p class="text-sm font-medium text-gray-400">Calificación Promedio</p>
                <p id="avg-rating" class="text-4xl font-bold text-yellow-400 mt-1">N/A</p>
            </div>

            <!-- Métrica: Total de Calificaciones --><div class="card p-4 rounded-lg shadow-xl text-center">
                <p class="text-sm font-medium text-gray-400">Total de Respuestas</p>
                <p id="total-ratings" class="text-4xl font-bold text-gray-200 mt-1">0</p>
            </div>

        </section>

        <!-- Gráficos de Datos --><section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Gráfico 1: Desempeño por Asesor (Barras) --><div class="card p-6 rounded-xl shadow-2xl">
                <h2 class="text-xl font-semibold mb-4 text-white">Promedio de Calificación por Asesor</h2>
                <!-- Altura fija para el contenedor del gráfico --><div class="h-64">
                    <canvas id="advisorChart"></canvas>
                </div>
            </div>

            <!-- Gráfico 2: Distribución de Puntuaciones (Dona) --><div class="card p-6 rounded-xl shadow-2xl">
                <h2 class="text-xl font-semibold mb-4 text-white">Distribución de Puntuaciones (1-5 Estrellas)</h2>
                <!-- Altura fija para el contenedor del gráfico --><div class="h-64">
                    <canvas id="scoreDistributionChart"></canvas>
                </div>
            </div>

        </section>

        <!-- Tabla de Datos Crudos (Para revisión y edición) --><section class="card p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-semibold mb-4 text-white">Datos Detallados de Calificaciones</h2>
            
            <!-- Sección de Perfil de Administrador -->
            <div class="mb-4 p-4 border border-gray-700 rounded-lg bg-gray-800 flex justify-between items-center">
                <div>
                    <p id="auth-status" class="text-sm text-yellow-400 mb-1">Estado de Autenticación: Cargando...</p>
                    <p class="text-sm">Perfil de Admin: <span id="admin-name-display" class="font-bold text-white">Cargando...</span> (ID: <span id="user-id-display" class="text-gray-400">...</span>)</p>
                </div>
                <div class="flex space-x-2">
                    <button id="edit-profile-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition duration-300 text-xs">
                        Editar Nombre
                    </button>
                    <button id="logout-button" class="bg-red-700 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition duration-300 text-xs">
                        Cerrar Sesión
                    </button>
                </div>
            </div>
            
            <!-- Formulario Oculto de Edición de Perfil -->
            <div id="profile-edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div class="card p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 class="text-lg font-semibold text-white mb-4">Editar Nombre de Administrador</h3>
                    <label for="admin-name-input" class="block text-sm font-medium text-gray-400 mb-2">Nuevo Nombre:</label>
                    <input type="text" id="admin-name-input" class="w-full mb-4 p-2" placeholder="Ej: Juan Gerente">
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-profile-edit" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                        <button id="save-profile-edit" class="bg-black hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg">Guardar</button>
                    </div>
                </div>
            </div>


            <!-- Contenedor con Scroll Vertical y Horizontal Interno --><div id="ratings-table-container">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Asesor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rating</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Comentario</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ratings-table-body" class="divide-y divide-gray-700">
                        <!-- Filas se insertarán con JavaScript --></tbody>
                </table>
            </div>
            <p id="no-data-message" class="text-center text-gray-500 mt-4 hidden">No hay datos de calificación para los filtros seleccionados.</p>
        </section>
        
        <!-- Modal de Confirmación para Eliminar (Customizado) --><div id="delete-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="card p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 class="text-lg font-semibold text-white mb-4">Confirmar Eliminación</h3>
                <p class="text-gray-400 mb-6">¿Estás seguro de que quieres eliminar esta calificación? Esta acción es irreversible.</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button id="confirm-delete" data-doc-id="" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Eliminar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Script de Firebase y Lógica del Dashboard --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, getDoc, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Descomentar para depuración

        // --------------------------------------------------------
        // 1. CONFIGURACIÓN GLOBAL
        // --------------------------------------------------------
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId, unsubscribeSnapshot;
        let allRatings = []; // Almacena todos los datos crudos
        const ADVISOR_NAMES = ['Juan', 'María', 'Pedro', 'Ana']; // Lista de asesores
        const ADVISOR_IDS = ['juan', 'maria', 'pedro', 'ana'];

        // Elementos del DOM (Login)
        const loginScreen = document.getElementById('login-screen');
        const mainDashboardContent = document.getElementById('main-dashboard-content');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const loginMessage = document.getElementById('login-message');
        const logoutButton = document.getElementById('logout-button');
        
        // Elementos del DOM (Dashboard)
        const asesorFilter = document.getElementById('asesor-filter');
        const monthFilter = document.getElementById('month-filter');
        const ratingsTableBody = document.getElementById('ratings-table-body');
        const avgRatingEl = document.getElementById('avg-rating');
        const totalRatingsEl = document.getElementById('total-ratings');
        const noDataMessage = document.getElementById('no-data-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const authStatusEl = document.getElementById('auth-status');
        const adminNameDisplay = document.getElementById('admin-name-display');
        
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const profileEditModal = document.getElementById('profile-edit-modal');
        const cancelProfileEditBtn = document.getElementById('cancel-profile-edit');
        const saveProfileEditBtn = document.getElementById('save-profile-edit');
        const adminNameInput = document.getElementById('admin-name-input');


        // Inicializar Gráficos (referencias globales)
        let advisorChartInstance, scoreDistributionChartInstance;
        const CHART_COLORS = {
            yellow: 'rgb(255, 205, 86)',
            red: 'rgb(255, 99, 132)',
            blue: 'rgb(54, 162, 235)',
            green: 'rgb(75, 192, 192)',
            purple: 'rgb(153, 102, 255)',
        };

        // --------------------------------------------------------
        // 2. UTILIDADES Y GRÁFICOS
        // --------------------------------------------------------

        function initializeCharts() {
            const advisorCtx = document.getElementById('advisorChart').getContext('2d');
            advisorChartInstance = new Chart(advisorCtx, {
                type: 'bar',
                data: {
                    labels: ADVISOR_NAMES, 
                    datasets: [{
                        label: 'Calificación Promedio',
                        data: ADVISOR_NAMES.map(() => 0),
                        backgroundColor: ADVISOR_NAMES.map((_, i) => [CHART_COLORS.blue, CHART_COLORS.green, CHART_COLORS.yellow, CHART_COLORS.purple][i % 4]),
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            title: { display: true, text: 'Promedio de Estrellas', color: '#d4d4d4' },
                            ticks: { color: '#d4d4d4' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            title: { display: true, text: 'Asesor', color: '#d4d4d4' },
                            ticks: { color: '#d4d4d4' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            const scoreCtx = document.getElementById('scoreDistributionChart').getContext('2d');
            scoreDistributionChartInstance = new Chart(scoreCtx, {
                type: 'doughnut',
                data: {
                    labels: ['1 Estrella', '2 Estrellas', '3 Estrellas', '4 Estrellas', '5 Estrellas'],
                    datasets: [{
                        label: 'Distribución de Calificaciones',
                        data: [0, 0, 0, 0, 0], 
                        backgroundColor: [
                            CHART_COLORS.red, 
                            CHART_COLORS.yellow, 
                            CHART_COLORS.green, 
                            CHART_COLORS.blue, 
                            CHART_COLORS.purple
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#d4d4d4' } },
                        tooltip: { callbacks: { label: (context) => {
                            let label = context.label || '';
                            if (label) { label += ': '; }
                            label += context.parsed + ' votos';
                            return label;
                        } } }
                    }
                }
            });
        }

        function populateAdvisorFilter() {
            ADVISOR_IDS.forEach((id, index) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = ADVISOR_NAMES[index];
                asesorFilter.appendChild(option);
            });
        }

        function applyFilters() {
            let filteredRatings = allRatings;
            const selectedAsesor = asesorFilter.value;
            const selectedMonth = monthFilter.value; 

            // 1. Filtrar por Asesor
            if (selectedAsesor !== 'all') {
                filteredRatings = filteredRatings.filter(r => r.advisorId === selectedAsesor);
            }

            // 2. Filtrar por Mes
            if (selectedMonth) {
                const [year, month] = selectedMonth.split('-').map(Number);
                filteredRatings = filteredRatings.filter(r => {
                    const date = new Date(r.timestamp);
                    // Date.getMonth() es base 0 (0=Ene, 11=Dic), por eso month-1
                    return date.getFullYear() === year && date.getMonth() === (month - 1);
                });
            }

            renderMetrics(filteredRatings);
            renderCharts(filteredRatings);
            renderTable(filteredRatings);
        }

        function renderMetrics(ratings) {
            const total = ratings.length;
            totalRatingsEl.textContent = total;

            if (total === 0) {
                avgRatingEl.textContent = 'N/A';
                return;
            }

            const totalScore = ratings.reduce((sum, r) => sum + r.rating, 0);
            const average = (totalScore / total).toFixed(2);
            avgRatingEl.textContent = average;
        }

        function renderCharts(ratings) {
            const advisorData = {};
            ADVISOR_IDS.forEach(id => advisorData[id] = { total: 0, count: 0 });

            ratings.forEach(r => {
                if (advisorData[r.advisorId]) {
                    advisorData[r.advisorId].total += r.rating;
                    advisorData[r.advisorId].count++;
                }
            });

            const chartLabels = [];
            const chartData = [];

            ADVISOR_IDS.forEach((id, index) => {
                const name = ADVISOR_NAMES[index];
                const data = advisorData[id];
                if (data.count > 0) {
                    chartLabels.push(name);
                    chartData.push((data.total / data.count).toFixed(2));
                }
            });
            
            advisorChartInstance.data.labels = chartLabels;
            advisorChartInstance.data.datasets[0].data = chartData;
            advisorChartInstance.update();

            const distribution = [0, 0, 0, 0, 0]; 

            ratings.forEach(r => {
                if (r.rating >= 1 && r.rating <= 5) {
                    distribution[r.rating - 1]++;
                }
            });

            scoreDistributionChartInstance.data.datasets[0].data = distribution;
            scoreDistributionChartInstance.update();
        }

        function renderTable(ratings) {
            ratingsTableBody.innerHTML = ''; 
            if (ratings.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            }
            noDataMessage.classList.add('hidden');

            const sortedRatings = ratings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedRatings.forEach(rating => {
                const date = new Date(rating.timestamp).toLocaleString('es-CO', {
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit'
                });

                const row = document.createElement('tr');
                row.className = 'text-gray-300 hover:bg-gray-800 transition duration-150';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${rating.advisorName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${'⭐'.repeat(rating.rating)} (${rating.rating})</td>
                    <td class="px-6 py-4 whitespace-normal text-sm">${rating.comments || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="showDeleteModal('${rating.id}')" class="text-red-500 hover:text-red-400 font-semibold focus:outline-none ml-2">Eliminar</button>
                    </td>
                `;
                ratingsTableBody.appendChild(row);
            });
        }

        // --------------------------------------------------------
        // 3. LÓGICA DE AUTENTICACIÓN
        // --------------------------------------------------------

        function setLoginMessage(message, isError = true) {
            loginMessage.textContent = message;
            loginMessage.classList.remove('hidden');
            loginMessage.classList.remove(isError ? 'text-green-400' : 'text-red-400');
            loginMessage.classList.add(isError ? 'text-red-400' : 'text-green-400');
        }

        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                setLoginMessage('Debes ingresar correo y contraseña.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                setLoginMessage('Error de inicio de sesión. Credenciales inválidas.');
            }
        });

        registerButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                setLoginMessage('Debes ingresar correo y contraseña para registrarte.');
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                setLoginMessage('Registro exitoso. Iniciando sesión...', false);
            } catch (error) {
                console.error("Error al registrarse:", error);
                setLoginMessage('Error al registrarse. La contraseña debe tener al menos 6 caracteres y el correo ser válido.');
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Sesión cerrada.");
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        });

        // --------------------------------------------------------
        // 4. LÓGICA DEL PERFIL DE ADMINISTRADOR
        // --------------------------------------------------------

        const ADMIN_PROFILE_DOC_ID = 'profile'; 
        
        function getAdminProfileDocRef() {
            if (!userId) {
                console.error("User ID no disponible para la referencia del perfil.");
                return null;
            }
            // Ruta: /artifacts/{appId}/users/{userId}/admin_profile/profile
            const collectionPath = `artifacts/${appId}/users/${userId}/admin_profile`;
            return doc(db, collectionPath, ADMIN_PROFILE_DOC_ID);
        }

        async function loadAdminProfile() {
            const docRef = getAdminProfileDocRef();
            if (!docRef) return;

            try {
                const docSnap = await getDoc(docRef);
                let profile = {};
                
                if (docSnap.exists()) {
                    profile = docSnap.data();
                    adminNameDisplay.textContent = profile.name || 'Admin Principal';
                    adminNameInput.value = profile.name || '';
                } else {
                    profile = { name: 'Admin Principal', userId: userId, createdAt: new Date().toISOString() };
                    await setDoc(docRef, profile);
                    adminNameDisplay.textContent = 'Admin Principal';
                    adminNameInput.value = 'Admin Principal';
                }
            } catch (error) {
                console.error("Error al cargar/crear perfil de admin:", error);
                adminNameDisplay.textContent = 'Error de carga';
            }
        }
        
        // Abrir Modal de Edición
        editProfileBtn.addEventListener('click', () => {
            profileEditModal.classList.remove('hidden');
        });

        // Cancelar Edición
        cancelProfileEditBtn.addEventListener('click', () => {
            profileEditModal.classList.add('hidden');
        });

        // Guardar Edición
        saveProfileEditBtn.addEventListener('click', async () => {
            const newName = adminNameInput.value.trim();
            if (!newName) {
                alert('El nombre no puede estar vacío.');
                return;
            }

            const docRef = getAdminProfileDocRef();
            if (!docRef) return;
            
            saveProfileEditBtn.disabled = true;
            saveProfileEditBtn.textContent = 'Guardando...';

            try {
                await setDoc(docRef, { name: newName, updatedAt: new Date().toISOString() }, { merge: true });
                adminNameDisplay.textContent = newName;
                profileEditModal.classList.add('hidden');
            } catch (error) {
                console.error("Error al guardar perfil:", error);
                alert('Error al guardar el perfil. Revisa la consola.');
            } finally {
                saveProfileEditBtn.disabled = false;
                saveProfileEditBtn.textContent = 'Guardar';
            }
        });

        // --------------------------------------------------------
        // 5. CONEXIÓN Y CONTROL DE ESTADO DE FIREBASE
        // --------------------------------------------------------
        
        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     authStatusEl.textContent = 'Error: Configuración de Firebase no cargada.';
                     return;
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Autenticación inicial del Canvas (si aplica)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
                
                // Listener de estado de autenticación
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuario autenticado (incluye login de email o token inicial)
                        userId = user.uid;
                        userIdDisplay.textContent = userId;

                        // Ocultar login y mostrar dashboard
                        loginScreen.classList.add('hidden');
                        mainDashboardContent.classList.remove('hidden');
                        authStatusEl.textContent = 'Conectado. Bienvenido(a).';

                        // Cargar perfil y datos
                        await loadAdminProfile(); 
                        startDataListener();

                    } else {
                        // Usuario no autenticado
                        userId = null;
                        
                        // Mostrar login y ocultar dashboard
                        loginScreen.classList.remove('hidden');
                        mainDashboardContent.classList.add('hidden');
                        
                        authStatusEl.textContent = 'Desconectado.';
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                authStatusEl.textContent = 'Error crítico de Firebase. Revisa la consola.';
            }
        }

        function startDataListener() {
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
            }
            
            const collectionPath = `artifacts/${appId}/public/data/whatsapp_ratings`;
            const q = query(collection(db, collectionPath));
            
            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                allRatings = [];
                snapshot.forEach((doc) => {
                    allRatings.push({ id: doc.id, ...doc.data() });
                });
                
                applyFilters(); 
            }, (error) => {
                console.error("Error al escuchar datos de Firestore:", error);
                authStatusEl.textContent = 'Error al cargar datos. Revisa las reglas de seguridad.';
            });
        }
        
        // --------------------------------------------------------
        // 6. LÓGICA DE ELIMINACIÓN Y MODAL
        // --------------------------------------------------------

        window.showDeleteModal = (docId) => {
            confirmDeleteBtn.dataset.docId = docId;
            deleteModal.classList.remove('hidden');
        };

        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', async (e) => {
            const docIdToDelete = e.currentTarget.dataset.docId;
            if (!docIdToDelete) {
                console.error("No se encontró ID de documento para eliminar.");
                return;
            }

            deleteModal.classList.add('hidden');
            e.currentTarget.disabled = true;
            e.currentTarget.textContent = 'Eliminando...';
            
            const collectionPath = `artifacts/${appId}/public/data/whatsapp_ratings`;
            const docRef = doc(db, collectionPath, docIdToDelete);

            try {
                await deleteDoc(docRef);
                console.log("Documento eliminado con éxito:", docIdToDelete);
            } catch (error) {
                console.error("Error al eliminar el documento:", error);
            } finally {
                e.currentTarget.disabled = false;
                e.currentTarget.textContent = 'Eliminar';
            }
        });
        
        // --------------------------------------------------------
        // 7. INICIALIZACIÓN
        // --------------------------------------------------------
        
        asesorFilter.addEventListener('change', applyFilters);
        monthFilter.addEventListener('change', applyFilters);

        populateAdvisorFilter();
        initializeCharts();
        initFirebase();
    </script>

</body>
</html>
