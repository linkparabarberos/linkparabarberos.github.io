<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Califica Nuestro Servicio</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #000;
      color: #f9fafb;
    }
    .rating-star {
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 3rem;   /* tama√±o del c√≠rculo */
  height: 3rem;
  border-radius: 9999px;           /* c√≠rculo */
  border: 2px solid transparent;   /* sin borde por defecto */
  background-color: #111827;       /* fondo oscuro detr√°s de la estrella */
  transition: transform 0.1s ease-in-out,
              border-color 0.15s,
              box-shadow 0.15s,
              background-color 0.15s;
  filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
}

.rating-star:hover {
  transform: scale(1.05);
  border-color: #4B5563;
}

/* ‚≠ê ESTRELLA SELECCIONADA */
.rating-star.active {
  border-color: #FACC15;                      /* borde amarillo */
  box-shadow: 0 0 0 3px rgba(250, 204, 21, .45);
  background-color: #1f2933;
  transform: scale(1.08);
}

  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <!-- CONTENEDOR PRINCIPAL -->
  <div id="survey-container" class="w-full max-w-lg p-8 rounded-2xl bg-neutral-950 border border-neutral-800 shadow-2xl">
    <div class="flex justify-center mb-6">
      <!-- Cambia el src por tu logo real -->
      <img src="logo.png" alt="Logo Barbero Pro" class="h-12 object-contain rounded-lg">
    </div>

    <h1 class="text-3xl font-extrabold text-center mb-2">¬°Califica tu Experiencia!</h1>
    <p class="text-center text-gray-300 mb-4">
      Ay√∫danos a mejorar tu experiencia de compra con el asesor:<br>
      <span id="asesor-name" class="font-semibold text-white">...</span>
    </p>

    <!-- Mensaje de estado -->
    <p id="status-message" class="text-center text-sm mb-4 text-yellow-400 hidden"></p>

    <!-- ID oculto de asesor -->
    <input type="hidden" id="advisor-id" value="">

    <!-- Estrellas -->
    <div class="mb-6 text-center">
      <label class="block text-lg font-medium text-gray-200 mb-3">
        ¬øC√≥mo calificar√≠as la atenci√≥n recibida?
      </label>
      <div id="rating-stars" class="flex justify-center space-x-3 text-4xl">
  <span class="rating-star" data-value="1">‚≠ê</span>
  <span class="rating-star" data-value="2">‚≠ê</span>
  <span class="rating-star" data-value="3">‚≠ê</span>
  <span class="rating-star" data-value="4">‚≠ê</span>
  <span class="rating-star" data-value="5">‚≠ê</span>
</div>
      <input type="hidden" id="rating-value" value="0">
    </div>

    <!-- Comentarios -->
    <div class="mb-6">
      <label for="comments" class="block text-sm font-medium text-gray-200 mb-2">
        Comentarios adicionales (opcional)
      </label>
      <textarea id="comments" rows="3"
        class="w-full p-3 border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm"
        placeholder="¬øQu√© podr√≠amos mejorar o qu√© te gust√≥ m√°s?"></textarea>
    </div>

    <!-- Bot√≥n enviar -->
    <button id="submit-button"
      class="w-full bg-white text-black font-semibold py-3 rounded-xl shadow-md hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed">
      Enviar calificaci√≥n
    </button>
  </div>

  <!-- MENSAJE DE √âXITO -->
  <div id="success-message" class="hidden w-full max-w-lg bg-emerald-600 text-white p-10 rounded-2xl shadow-2xl text-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none"
      viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <h2 class="text-2xl font-bold mb-2">¬°Gracias por tu tiempo!</h2>
    <p class="text-lg">Tu calificaci√≥n ha sido registrada con √©xito.</p>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // üîê Config de tu proyecto
    const firebaseConfig = {
      apiKey: "AIzaSyBzlULX6R3zu_7HxLYUWG4WFIqrKXpeLSg",
      authDomain: "linkparabarberos.firebaseapp.com",
      projectId: "linkparabarberos",
      storageBucket: "linkparabarberos.firebasestorage.app",
      messagingSenderId: "237275244830",
      appId: "1:237275244830:web:51c5a95a81c1287512810f",
      measurementId: "G-SX4F2EL0C0"
    };

    const globalAppId = firebaseConfig.projectId;
    let app, db, auth, userId;

    const statusMessage = document.getElementById("status-message");
    const submitButton  = document.getElementById("submit-button");

    // ---------- 1. INICIAR FIREBASE + LOGIN AN√ìNIMO ----------
    async function initFirebase() {
      try {
        app  = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db   = getFirestore(app);

        statusMessage.textContent = "Autenticando...";
        statusMessage.classList.remove("hidden");

        const cred = await signInAnonymously(auth);
        userId = cred.user.uid;

        statusMessage.textContent = "Listo para calificar.";
        setTimeout(() => statusMessage.classList.add("hidden"), 1500);
      } catch (error) {
        console.error("Error al inicializar Firebase:", error);
        statusMessage.textContent = "Error al cargar la aplicaci√≥n. Intenta m√°s tarde.";
      }
    }

    // ---------- 2. LEER ASESOR DE LA URL ----------
    const urlParams = new URLSearchParams(window.location.search);
    const advisorIdFromUrl = urlParams.get("asesor");   // ?asesor=asesor1
    const asesorNameEl     = document.getElementById("asesor-name");
    const advisorIdInput   = document.getElementById("advisor-id");

    // Mapa simple
    const advisorMap = {
      "asesor1": "Jennifer Andrea Manzanares",
      "asesor2": "Daniela Barragan Pati√±o",
      "asesor3": "Jorge Leonardo Bedoya",
      "asesor4": "Javier Francisco Mamian"
    };

    const asesorNombre = advisorMap[advisorIdFromUrl?.toLowerCase()] || null;

    if (asesorNombre) {
      asesorNameEl.textContent = asesorNombre;
      advisorIdInput.value = advisorIdFromUrl.toLowerCase();
      submitButton.disabled = false;
    } else {
      asesorNameEl.textContent = "¬°Asesor desconocido!";
      asesorNameEl.classList.add("text-red-400");
      submitButton.disabled = true;
      statusMessage.textContent = "Link de calificaci√≥n inv√°lido. Revisa el enlace.";
      statusMessage.classList.remove("hidden");
    }
    // ---------- 3. ESTRELLAS ----------
const ratingStars      = document.getElementById("rating-stars");
const ratingValueInput = document.getElementById("rating-value");
const commentsInput    = document.getElementById("comments");

ratingStars.querySelectorAll(".rating-star").forEach(star => {
  star.addEventListener("click", () => {
    const value = parseInt(star.dataset.value, 10);
    ratingValueInput.value = value;

    // Activa todas las <= valor seleccionado y apaga las dem√°s
    ratingStars.querySelectorAll(".rating-star").forEach(s => {
      const v = parseInt(s.dataset.value, 10);
      if (v <= value) {
        s.classList.add("active");
      } else {
        s.classList.remove("active");
      }
    });
  });
});

    // ---------- 4. ENVIAR A FIRESTORE ----------
    submitButton.addEventListener("click", async () => {
      const rating = parseInt(ratingValueInput.value, 10);
      const comments = commentsInput.value.trim();
      const advisorID = advisorIdInput.value;
      const advisorDisplayName = asesorNameEl.textContent;

      if (!advisorID) {
        statusMessage.textContent = "Asesor inv√°lido. Revisa el enlace.";
        statusMessage.classList.remove("hidden");
        statusMessage.classList.add("text-red-400");
        return;
      }

      if (!rating || rating < 1 || rating > 5) {
        statusMessage.textContent = "Por favor selecciona una calificaci√≥n de 1 a 5 estrellas.";
        statusMessage.classList.remove("hidden");
        statusMessage.classList.add("text-red-400");
        return;
      }

      if (!db) {
        console.error("Firestore no est√° inicializado.");
        statusMessage.textContent = "Error interno. Intenta m√°s tarde.";
        statusMessage.classList.remove("hidden");
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = "Enviando...";

      const ratingData = {
        advisorId: advisorID,
        advisorName: advisorDisplayName,
        rating: rating,
        comments: comments,
        timestamp: new Date().toISOString(), // <- AQU√ç se guarda fecha/hora
        platform: "WhatsApp",
        client_id: userId
      };

      const collectionPath = `artifacts/${globalAppId}/public/data/whatsapp_ratings`;
      const docRef = doc(collection(db, collectionPath));

      try {
        await setDoc(docRef, ratingData);
        console.log("Calificaci√≥n enviada con ID:", docRef.id);
        document.getElementById("survey-container").classList.add("hidden");
        document.getElementById("success-message").classList.remove("hidden");
      } catch (e) {
        console.error("Error al guardar calificaci√≥n:", e);
        statusMessage.textContent = "Hubo un error al guardar. Intenta de nuevo.";
        statusMessage.classList.remove("hidden");
        statusMessage.classList.add("text-red-400");
        submitButton.disabled = false;
        submitButton.textContent = "Enviar calificaci√≥n";
      }
    });

    // Iniciar Firebase
    initFirebase();
  </script>
</body>
</html>
