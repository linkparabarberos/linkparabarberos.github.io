<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Califica Nuestro Servicio</title>
  <!-- FAVICON -->
<link rel="icon" type="image/png" sizes="32x32" href="./logopb.png">
<link rel="icon" type="image/png" sizes="16x16" href="./logopb.png">
<link rel="apple-touch-icon" href="./logopb.png">


  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #000;
      color: #f9fafb;
    }

    .rating-star {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 3rem;
      height: 3rem;
      border-radius: 9999px;
      border: 2px solid transparent;
      background-color: #111827;
      transition: transform 0.1s ease-in-out, border-color 0.15s,
        box-shadow 0.15s, background-color 0.15s;
      filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
    }

    .rating-star:hover {
      transform: scale(1.05);
      border-color: #4b5563;
    }

    .rating-star.active {
      border-color: #facc15;
      box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.45);
      background-color: #1f2933;
      transform: scale(1.08);
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <!-- CONTENEDOR PRINCIPAL -->
  <div
    id="survey-container"
    class="w-full max-w-lg p-8 rounded-2xl bg-neutral-950 border border-neutral-800 shadow-2xl"
  >
    <div class="flex justify-center mb-6">
      <!-- CAMBIA 'logopb.png' POR EL NOMBRE DE TU LOGO -->
      <img
        src="logopb.png"
        alt="Logo Parabarberos"
        class="h-20 object-contain rounded-lg"
      />
    </div>

    <h1 class="text-3xl font-extrabold text-center mb-2">
      ¬°Califica tu Experiencia!
    </h1>
    <p class="text-center text-gray-300 mb-4">
      Ay√∫danos a mejorar tu experiencia de compra con el asesor:<br />
      <span id="asesor-name" class="font-semibold text-white">...</span>
    </p>

    <!-- Mensaje de estado -->
    <p
      id="status-message"
      class="text-center text-sm mb-4 text-yellow-400 hidden"
    ></p>

    <!-- IDs ocultos -->
    <input type="hidden" id="advisor-id" value="" />
    <input type="hidden" id="client-phone-hidden" value="" />

    <!-- Estrellas -->
    <div class="mb-6 text-center">
      <label class="block text-lg font-medium text-gray-200 mb-3">
        ¬øCu√°l es el nivel de satisfacci√≥n con la atenci√≥n recibida?
      </label>
      <div id="rating-stars" class="flex justify-center space-x-3 text-4xl">
        <span class="rating-star" data-value="1">‚≠ê</span>
        <span class="rating-star" data-value="2">‚≠ê</span>
        <span class="rating-star" data-value="3">‚≠ê</span>
        <span class="rating-star" data-value="4">‚≠ê</span>
        <span class="rating-star" data-value="5">‚≠ê</span>
      </div>
      <input type="hidden" id="rating-value" value="0" />
    </div>

    <!-- Comentarios -->
    <div class="mb-6">
      <label
        for="comments"
        class="block text-sm font-medium text-gray-200 mb-2"
      >
        ¬øTienes alguna sugerencia que nos ayude a mejorar?
      </label>
      <textarea
        id="comments"
        rows="3"
        class="w-full p-3 border rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm text-black placeholder-gray-400"
        placeholder="¬øQu√© podr√≠amos mejorar o qu√© te gust√≥ m√°s?"
      ></textarea>
    </div>

    <!-- Bot√≥n enviar -->
    <button
      id="submit-button"
      class="w-full bg-white text-black font-semibold py-3 rounded-xl shadow-md hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Enviar calificaci√≥n
    </button>
  </div>

  <!-- MENSAJE DE √âXITO -->
  <div
    id="success-message"
    class="hidden w-full max-w-lg bg-emerald-600 text-white p-10 rounded-2xl shadow-2xl text-center"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-16 w-16 mx-auto mb-4"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <h2 class="text-2xl font-bold mb-2">¬°Gracias por tu tiempo!</h2>
    <p class="text-lg">Tu calificaci√≥n ha sido registrada con √©xito.</p>
  </div>

  <!-- MODAL CALIFICACI√ìN BAJA -->
  <div
    id="low-rating-modal"
    class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden"
  >
    <div
      class="bg-neutral-950 border border-red-500/60 rounded-2xl p-6 max-w-sm w-full shadow-2xl"
    >
      <h2 class="text-xl font-bold text-white mb-2">
        Lamentamos tu experiencia üòî
      </h2>
      <p class="text-sm text-gray-300 mb-4">
        Queremos comunicarnos contigo para entender mejor lo que pas√≥ y
        ayudarte. Por favor d√©janos tu n√∫mero de WhatsApp:
      </p>

      <label for="client-phone" class="block text-xs text-gray-400 mb-1">
        N√∫mero de tel√©fono
      </label>
      <input
        id="client-phone"
        type="tel"
        placeholder="Ej: 300 123 4567"
        class="w-full px-3 py-2 rounded-lg border border-gray-600 bg-black text-white text-sm
               focus:outline-none focus:ring-2 focus:ring-red-400/70 mb-2"
      />

      <p id="phone-error" class="text-xs text-red-400 mb-3 hidden">
        Por favor ingresa un n√∫mero de tel√©fono v√°lido.
      </p>

      <div class="flex justify-end gap-2">
        <button
          id="close-phone-btn"
          type="button"
          class="px-3 py-2 rounded-lg text-xs text-gray-300 hover:bg-neutral-800"
        >
          Cancelar
        </button>
        <button
          id="save-phone-btn"
          type="button"
          class="px-3 py-2 rounded-lg bg-red-500 hover:bg-red-400 text-xs font-semibold text-white"
        >
          Guardar n√∫mero
        </button>
      </div>
    </div>
  </div>

  <!-- FIREBASE + L√ìGICA -->
  <script type="module">
  console.log("JS del formulario cargado");

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    collection,
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // CONFIG FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyBzlULX6R3zu_7HxLYUWG4WFIqrKXpeLSg",
    authDomain: "linkparabarberos.firebaseapp.com",
    projectId: "linkparabarberos",
    storageBucket: "linkparabarberos.firebasestorage.app",
    messagingSenderId: "237275244830",
    appId: "1:237275244830:web:51c5a95a81c1287512810f",
    measurementId: "G-SX4F2EL0C0",
  };

  const globalAppId = firebaseConfig.projectId;
  let app, db, auth, userId;

  // ELEMENTOS DOM
  const statusMessage = document.getElementById("status-message");
  const submitButton = document.getElementById("submit-button");
  const ratingStars = document.getElementById("rating-stars");
  const ratingValueInput = document.getElementById("rating-value");
  const commentsInput = document.getElementById("comments");
  const asesorNameEl = document.getElementById("asesor-name");
  const advisorIdInput = document.getElementById("advisor-id");
  const clientPhoneHidden = document.getElementById("client-phone-hidden");

  // Modal de calificaci√≥n baja
  const lowRatingModal = document.getElementById("low-rating-modal");
  const clientPhoneInput = document.getElementById("client-phone");
  const phoneErrorEl = document.getElementById("phone-error");
  const savePhoneBtn = document.getElementById("save-phone-btn");
  const closePhoneBtn = document.getElementById("close-phone-btn");

  // Flags
  let skipPhoneForThisRating = false;      // el cliente ya decidi√≥ si deja tel√©fono o no
  let pendingSubmitAfterModal = false;     // hay un env√≠o pendiente despu√©s del modal

  function openLowRatingModal() {
    phoneErrorEl.classList.add("hidden");
    clientPhoneInput.value = clientPhoneHidden.value || "";
    lowRatingModal.classList.remove("hidden");
    setTimeout(() => clientPhoneInput?.focus(), 10);
  }

  function closeLowRatingModal() {
    lowRatingModal.classList.add("hidden");
  }

  // INICIAR FIREBASE
  async function initFirebase() {
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);

      statusMessage.textContent = "Autenticando...";
      statusMessage.classList.remove("hidden");

      const cred = await signInAnonymously(auth);
      userId = cred.user.uid;

      statusMessage.textContent = "Listo para calificar.";
      setTimeout(() => statusMessage.classList.add("hidden"), 1500);
    } catch (error) {
      console.error("Error al inicializar Firebase:", error);
      statusMessage.textContent =
        "Error al cargar la aplicaci√≥n. Intenta m√°s tarde.";
      statusMessage.classList.remove("hidden");
      statusMessage.classList.add("text-red-400");
    }
  }

  // NOMBRE DEL ASESOR DESDE LA URL
  const urlParams = new URLSearchParams(window.location.search);
  const advisorIdFromUrl = urlParams.get("asesor"); // ?asesor=asesor1

  const advisorMap = {
    asesor1: "Jennifer Andrea Manzanares",
    asesor2: "Daniela Barragan Pati√±o",
    asesor3: "Jorge Leonardo Bedoya",
    asesor4: "Javier Francisco Mamian",
  };

  const asesorNombre =
    advisorMap[advisorIdFromUrl?.toLowerCase()] || null;

  if (asesorNombre) {
    asesorNameEl.textContent = asesorNombre;
    advisorIdInput.value = advisorIdFromUrl.toLowerCase();
    submitButton.disabled = false;
  } else {
    asesorNameEl.textContent = "¬°Asesor desconocido!";
    asesorNameEl.classList.add("text-red-400");
    submitButton.disabled = true;
    statusMessage.textContent =
      "Link de calificaci√≥n inv√°lido. Revisa el enlace.";
    statusMessage.classList.remove("hidden");
    statusMessage.classList.add("text-red-400");
  }

  // ESTRELLAS (solo marcan visual, no abren modal)
  if (ratingStars) {
    ratingStars.querySelectorAll(".rating-star").forEach((star) => {
      star.addEventListener("click", () => {
        const value = parseInt(star.dataset.value, 10);
        ratingValueInput.value = value;

        ratingStars.querySelectorAll(".rating-star").forEach((s) => {
          const v = parseInt(s.dataset.value, 10);
          if (v <= value) {
            s.classList.add("active");
          } else {
            s.classList.remove("active");
          }
        });

        // al cambiar de calificaci√≥n, reseteamos la decisi√≥n
        skipPhoneForThisRating = false;

        // si la nota es buena, limpiamos tel√©fono opcional
        if (value > 2) {
          clientPhoneHidden.value = "";
        }
      });
    });
  }

  // FUNCI√ìN GENERAL DE ENV√çO A FIRESTORE
  async function doSubmit() {
    const rating = parseInt(ratingValueInput.value, 10);
    const comments = commentsInput.value.trim();
    const advisorID = advisorIdInput.value;
    const advisorDisplayName = asesorNameEl.textContent;
    const phoneFromHidden = clientPhoneHidden.value.trim();

    if (!advisorID) {
      statusMessage.textContent = "Asesor inv√°lido. Revisa el enlace.";
      statusMessage.classList.remove("hidden");
      statusMessage.classList.add("text-red-400");
      return;
    }

    if (!rating || rating < 1 || rating > 5) {
      statusMessage.textContent =
        "Por favor selecciona una calificaci√≥n de 1 a 5 estrellas.";
      statusMessage.classList.remove("hidden");
      statusMessage.classList.add("text-red-400");
      return;
    }

    if (!db) {
      statusMessage.textContent =
        "Error interno. No se pudo conectar a la base de datos.";
      statusMessage.classList.remove("hidden");
      statusMessage.classList.add("text-red-400");
      return;
    }

    submitButton.disabled = true;
    submitButton.textContent = "Enviando...";
    statusMessage.classList.add("hidden");

    const ratingData = {
      advisorId: advisorID,
      advisorName: advisorDisplayName,
      rating,
      comments,
      timestamp: new Date().toISOString(),
      platform: "WhatsApp",
      client_id: userId,
      clientPhone: phoneFromHidden || null,
    };

    const collectionPath = `artifacts/${globalAppId}/public/data/whatsapp_ratings`;
    const docRef = doc(collection(db, collectionPath));

    try {
      await setDoc(docRef, ratingData);
      document.getElementById("survey-container").classList.add("hidden");
      document.getElementById("success-message").classList.remove("hidden");
    } catch (e) {
      console.error("Error al guardar calificaci√≥n:", e);
      statusMessage.textContent =
        "Hubo un error al guardar. Intenta de nuevo.";
      statusMessage.classList.remove("hidden");
      statusMessage.classList.add("text-red-400");
      submitButton.disabled = false;
      submitButton.textContent = "Enviar calificaci√≥n";
    }
  }

  // BOT√ìN GUARDAR N√öMERO (modal)
  savePhoneBtn.addEventListener("click", async () => {
    const phone = clientPhoneInput.value.trim();

    // Tel√©fono OPCIONAL: solo marcamos error si escribi√≥ algo muy corto
    if (phone && phone.length < 7) {
      phoneErrorEl.textContent =
        "Por favor ingresa un n√∫mero de tel√©fono v√°lido.";
      phoneErrorEl.classList.remove("hidden");
      return;
    }

    clientPhoneHidden.value = phone; // puede ser vac√≠o (no pasa nada)
    skipPhoneForThisRating = true;   // no volver a pedir para esta calificaci√≥n
    closeLowRatingModal();

    if (pendingSubmitAfterModal) {
      pendingSubmitAfterModal = false;
      await doSubmit(); // enviar autom√°ticamente
    }
  });

  // BOT√ìN CANCELAR (modal) ‚Üí no quiere dejar n√∫mero, pero igual se env√≠a
  closePhoneBtn.addEventListener("click", async () => {
    skipPhoneForThisRating = true;
    clientPhoneHidden.value = ""; // expl√≠citamente sin tel√©fono
    closeLowRatingModal();

    if (pendingSubmitAfterModal) {
      pendingSubmitAfterModal = false;
      await doSubmit(); // enviar autom√°ticamente SIN tel√©fono
    }
  });

  // BOT√ìN ENVIAR CALIFICACI√ìN
  submitButton.addEventListener("click", async () => {
    const rating = parseInt(ratingValueInput.value, 10);
    const advisorID = advisorIdInput.value;
    const phoneFromHidden = clientPhoneHidden.value.trim();

    // Validaciones r√°pidas antes de abrir modal
    if (!advisorID) {
      statusMessage.textContent = "Asesor inv√°lido. Revisa el enlace.";
      statusMessage.classList.remove("hidden");
      statusMessage.classList.add("text-red-400");
      return;
    }
    if (!rating || rating < 1 || rating > 5) {
      statusMessage.textContent =
        "Por favor selecciona una calificaci√≥n de 1 a 5 estrellas.";
      statusMessage.classList.remove("hidden");
      statusMessage.classList.add("text-red-400");
      return;
    }

    // Si la calificaci√≥n es baja (1‚Äì2) y a√∫n no hemos preguntado, abrimos modal
    if (rating <= 2 && !skipPhoneForThisRating && !phoneFromHidden) {
      pendingSubmitAfterModal = true;
      openLowRatingModal();
      return;
    }

    // Si ya no hay que preguntar (o nota > 2), enviamos directo
    await doSubmit();
  });

  // Iniciar Firebase al cargar
  initFirebase();
</script>
</body>
</html>
